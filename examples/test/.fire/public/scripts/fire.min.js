"use strict";function _getUUID(a){var b;if("undefined"!=typeof a.toQueryValue)b=a.toQueryValue();else{if("string"!=typeof a){var c=new FireError("Parameter `"+a+"` is not a valid model instance or UUID.");throw c.status=400,c}b=a}return b}function FireError(a){this.name="FireError",this.message=a||"",this.number=-1}function FireModelInstance(a,b,c){this._map=a||{},this._changes={},this._model=b,this._endpoint=this._map.id?c+"/"+this._map.id:null}function FireModel(a,b,c){this.$http=a,this.$q=b,this.models=c}function transformQueryMap(a,b){var c={};return Object.keys(a||{}).forEach(function(b){var d=a[b];c[b]=d&&"undefined"!=typeof d.toQueryValue?d.toQueryValue():d}),b&&(c.$options=b),c}function FireModelInstanceTest(a,b,c){var d=this;Object.defineProperty(this,"id",{get:function(){return"undefined"!=typeof d._changes.id?d._changes.id:d._map.id},set:function(a){d._changes.id=a}}),Object.defineProperty(this,"name",{get:function(){return"undefined"!=typeof d._changes.name?d._changes.name:d._map.name},set:function(a){d._changes.name=a}}),"undefined"!=typeof a.sessions&&null!==a.sessions&&(a.sessions=Array.isArray(a.sessions)?a.sessions.map(function(a){return new FireModelInstanceTestSession(a,b.models.TestSession,c+"/sessions")}):new FireModelInstanceTestSession(a.sessions,b.models.TestSession,c+"/sessions")),Object.defineProperty(this,"sessions",{get:function(){return"undefined"!=typeof d._changes.sessions?d._changes.sessions:d._map.sessions},set:function(a){d._changes.sessions=a}}),"undefined"!=typeof a.variants&&null!==a.variants&&(a.variants=Array.isArray(a.variants)?a.variants.map(function(a){return new FireModelInstanceTestVariant(a,b.models.TestVariant,c+"/variants")}):new FireModelInstanceTestVariant(a.variants,b.models.TestVariant,c+"/variants")),Object.defineProperty(this,"variants",{get:function(){return"undefined"!=typeof d._changes.variants?d._changes.variants:d._map.variants},set:function(a){d._changes.variants=a}}),FireModelInstance.call(this,a,b,c)}function FireModelTest(a,b,c){FireModel.call(this,a,b,c),this.endpoint="/api/tests"}function FireModelInstanceTestParticipant(a,b,c){var d=this;Object.defineProperty(this,"id",{get:function(){return"undefined"!=typeof d._changes.id?d._changes.id:d._map.id},set:function(a){d._changes.id=a}}),"undefined"!=typeof a.sessions&&null!==a.sessions&&(a.sessions=Array.isArray(a.sessions)?a.sessions.map(function(a){return new FireModelInstanceTestSession(a,b.models.TestSession,c+"/sessions")}):new FireModelInstanceTestSession(a.sessions,b.models.TestSession,c+"/sessions")),Object.defineProperty(this,"sessions",{get:function(){return"undefined"!=typeof d._changes.sessions?d._changes.sessions:d._map.sessions},set:function(a){d._changes.sessions=a}}),FireModelInstance.call(this,a,b,c)}function FireModelTestParticipant(a,b,c){FireModel.call(this,a,b,c),this.endpoint="/api/test-participants"}function FireModelInstanceTestSession(a,b,c){var d=this;Object.defineProperty(this,"id",{get:function(){return"undefined"!=typeof d._changes.id?d._changes.id:d._map.id},set:function(a){d._changes.id=a}}),"undefined"!=typeof a.test&&null!==a.test&&(a.test=Array.isArray(a.test)?a.test.map(function(a){return new FireModelInstanceTest(a,b.models.Test,c+"/tests")}):new FireModelInstanceTest(a.test,b.models.Test,c+"/tests")),Object.defineProperty(this,"test",{get:function(){return"undefined"!=typeof d._changes.test?d._changes.test:d._map.test},set:function(a){d._changes.test=a}}),"undefined"!=typeof a.participant&&null!==a.participant&&(a.participant=Array.isArray(a.participant)?a.participant.map(function(a){return new FireModelInstanceTestParticipant(a,b.models.TestParticipant,c+"/participants")}):new FireModelInstanceTestParticipant(a.participant,b.models.TestParticipant,c+"/participants")),Object.defineProperty(this,"participant",{get:function(){return"undefined"!=typeof d._changes.participant?d._changes.participant:d._map.participant},set:function(a){d._changes.participant=a}}),Object.defineProperty(this,"variant",{get:function(){return"undefined"!=typeof d._changes.variant?d._changes.variant:d._map.variant},set:function(a){d._changes.variant=a}}),Object.defineProperty(this,"createdAt",{get:function(){return"undefined"!=typeof d._changes.createdAt?d._changes.createdAt:d._map.createdAt},set:function(a){d._changes.createdAt=a}}),FireModelInstance.call(this,a,b,c)}function FireModelTestSession(a,b,c){FireModel.call(this,a,b,c),this.endpoint="/api/test-sessions"}function FireModelInstanceTestVariant(a,b,c){var d=this;Object.defineProperty(this,"id",{get:function(){return"undefined"!=typeof d._changes.id?d._changes.id:d._map.id},set:function(a){d._changes.id=a}}),Object.defineProperty(this,"name",{get:function(){return"undefined"!=typeof d._changes.name?d._changes.name:d._map.name},set:function(a){d._changes.name=a}}),Object.defineProperty(this,"numberOfParticipants",{get:function(){return"undefined"!=typeof d._changes.numberOfParticipants?d._changes.numberOfParticipants:d._map.numberOfParticipants},set:function(a){d._changes.numberOfParticipants=a}}),"undefined"!=typeof a.test&&null!==a.test&&(a.test=Array.isArray(a.test)?a.test.map(function(a){return new FireModelInstanceTest(a,b.models.Test,c+"/tests")}):new FireModelInstanceTest(a.test,b.models.Test,c+"/tests")),Object.defineProperty(this,"test",{get:function(){return"undefined"!=typeof d._changes.test?d._changes.test:d._map.test},set:function(a){d._changes.test=a}}),FireModelInstance.call(this,a,b,c)}function FireModelTestVariant(a,b,c){FireModel.call(this,a,b,c),this.endpoint="/api/test-variants"}function unwrap(a,b){var c=b;return a.then(function(a){angular.copy(a,c)}),c}var app=angular.module("default",["ngRoute"]);app.config(["TestsServiceProvider",function(a){a.delegate(function(a,b){console.log("Join test "+a+" with variant "+b);var c={};c[a]=b,mixpanel.register(c)})}]),app.controller("StartController",["TextOfButtonTest","$scope",function(a,b){b.buttonText="A"==a.getVariant()?"Register for FREE":"Register now",b.register=function(){mixpanel.track("Register")}}]),FireError.prototype=new Error,FireModelInstance.prototype.refresh=function(a){return this._map=a._map,this},FireModelInstance.prototype.toQueryValue=function(){return this._map.id},FireModelInstance.prototype.remove=function(){return this._model.remove(this._map.id)},FireModelInstance.prototype.save=function(){var a=this;return this._model.$q.when(Object.keys(this._changes).length).then(function(b){if(b){var c=transformQueryMap(a._changes);return a._model._put(a._endpoint,c).then(function(b){return a._changes={},Object.keys(b._map).forEach(function(c){null!==b._map[c]&&(a._map[c]=b._map[c])}),a})}return a})},FireModel.prototype._prepare=function(a){var b={};return Object.keys(a||{}).forEach(function(c){b[c]=JSON.stringify(a[c])}),b},FireModel.prototype._action=function(a,b,c,d){var e=this.$q.defer(),f=this;return this.$http({method:a,url:b,data:d,params:c,headers:{"x-json-params":!0}}).success(function(a){e.resolve(f.parseResult(a,b))}).error(function(a,b){var c=new FireError(a);c.number=b,e.reject(c)}),e.promise},FireModel.prototype._post=function(a,b){return this._action("post",a,null,this._prepare(b))},FireModel.prototype._get=function(a,b){return this._action("get",a,this._prepare(b))},FireModel.prototype._put=function(a,b){return this._action("put",a,null,this._prepare(b))},FireModel.prototype.update=function(a,b){var c=transformQueryMap(b);return this._put(this.endpoint+"/"+a,c)},FireModel.prototype.remove=function(a){var b=null;return"undefined"!=typeof a.toQueryValue?b=a.toQueryValue():"string"==typeof a&&(b=a),b?this._action("delete",this.endpoint+"/"+b):this._action("delete",this.endpoint,this._prepare(transformQueryMap(a)))},FireModel.prototype.findOrCreate=function(a,b){var c=this;return this.findOne(a).then(function(d){if(d)return d;var e={};return Object.keys(a||{}).forEach(function(b){e[b]=a[b]}),Object.keys(b||{}).forEach(function(a){e[a]=b[a]}),c.create(e)})},FireModel.prototype._create=function(a,b){var c=transformQueryMap(b);return this._post(a,c)},FireModel.prototype.create=function(a){return this._create(this.endpoint,a)},FireModel.prototype._find=function(a,b,c){var d=transformQueryMap(b,c);return this._get(a,d)},FireModel.prototype.find=function(a,b){return this._find(this.endpoint,a,b)},FireModel.prototype.findOne=function(a,b){var c=a||{};if(c.id){var d=c.id;delete c.id;var e=this;return this._get(this.endpoint+"/"+d,transformQueryMap(c)).then(function(a){return a&&(a._endpoint=e.endpoint+"/"+d),a})}var f=b||{};return f.limit=1,this.find(c,f).then(function(a){return a&&a.length?a[0]:null})},FireModel.prototype.getOne=function(a){var b=this.$q.defer();return this.findOne(a).then(function(a){if(a)b.resolve(a);else{var c=new FireError("Not Found");c.number=404,b.reject(c)}}),b.promise},FireModelInstanceTest.prototype=Object.create(FireModelInstance.prototype),FireModelInstanceTest.prototype.getSessions=function(a,b){var c=this;return this._model.models.TestSession._find(this._model.endpoint+"/"+this.id+"/sessions",a,b).then(function(a){return c.sessions=a,a})},FireModelInstanceTest.prototype.createSession=function(a){var b=this;return this._model.models.TestSession._create(this._model.endpoint+"/"+this.id+"/sessions",a).then(function(a){return b.sessions||(b.sessions=[]),b.sessions.push(a),a})},FireModelInstanceTest.prototype.removeSession=function(a){var b=_getUUID(a),c=this;return this._model.models.TestSession._action("delete",this._model.endpoint+"/"+this.id+"/sessions/"+b).then(function(a){for(var d=0,e=c.sessions.length;e>d;d++){var f=c.sessions[d];if(f.id===b){c.sessions.splice(d,1);break}}return a})},FireModelInstanceTest.prototype.removeSessions=function(a){var b=this;return this._model.models.TestSession._action("delete",this._model.endpoint+"/"+this.id+"/sessions",this._model._prepare(transformQueryMap(a))).then(function(a){var c=a.map(function(a){return a.id});return b.sessions=b.sessions.filter(function(a){return-1!==c.indexOf(a.id)}),a})},FireModelInstanceTest.prototype.getVariants=function(a,b){var c=this;return this._model.models.TestVariant._find(this._model.endpoint+"/"+this.id+"/variants",a,b).then(function(a){return c.variants=a,a})},FireModelInstanceTest.prototype.createVariant=function(a){var b=this;return this._model.models.TestVariant._create(this._model.endpoint+"/"+this.id+"/variants",a).then(function(a){return b.variants||(b.variants=[]),b.variants.push(a),a})},FireModelInstanceTest.prototype.removeVariant=function(a){var b=_getUUID(a),c=this;return this._model.models.TestVariant._action("delete",this._model.endpoint+"/"+this.id+"/variants/"+b).then(function(a){for(var d=0,e=c.variants.length;e>d;d++){var f=c.variants[d];if(f.id===b){c.variants.splice(d,1);break}}return a})},FireModelInstanceTest.prototype.removeVariants=function(a){var b=this;return this._model.models.TestVariant._action("delete",this._model.endpoint+"/"+this.id+"/variants",this._model._prepare(transformQueryMap(a))).then(function(a){var c=a.map(function(a){return a.id});return b.variants=b.variants.filter(function(a){return-1!==c.indexOf(a.id)}),a})},FireModelTest.prototype=Object.create(FireModel.prototype),FireModelTest.prototype.parseResult=function(a,b){if("[object Array]"===Object.prototype.toString.call(a)){var c=this;return a.map(function(a){return new FireModelInstanceTest(a,c,b)})}return new FireModelInstanceTest(a,this,b)},app.factory("TestModel",["$http","$q","FireModels",function(a,b,c){return new FireModelTest(a,b,c)}]),FireModelInstanceTestParticipant.prototype=Object.create(FireModelInstance.prototype),FireModelInstanceTestParticipant.prototype.getSessions=function(a,b){var c=this;return this._model.models.TestSession._find(this._model.endpoint+"/"+this.id+"/sessions",a,b).then(function(a){return c.sessions=a,a})},FireModelInstanceTestParticipant.prototype.createSession=function(a){var b=this;return this._model.models.TestSession._create(this._model.endpoint+"/"+this.id+"/sessions",a).then(function(a){return b.sessions||(b.sessions=[]),b.sessions.push(a),a})},FireModelInstanceTestParticipant.prototype.removeSession=function(a){var b=_getUUID(a),c=this;return this._model.models.TestSession._action("delete",this._model.endpoint+"/"+this.id+"/sessions/"+b).then(function(a){for(var d=0,e=c.sessions.length;e>d;d++){var f=c.sessions[d];if(f.id===b){c.sessions.splice(d,1);break}}return a})},FireModelInstanceTestParticipant.prototype.removeSessions=function(a){var b=this;return this._model.models.TestSession._action("delete",this._model.endpoint+"/"+this.id+"/sessions",this._model._prepare(transformQueryMap(a))).then(function(a){var c=a.map(function(a){return a.id});return b.sessions=b.sessions.filter(function(a){return-1!==c.indexOf(a.id)}),a})},FireModelTestParticipant.prototype=Object.create(FireModel.prototype),FireModelTestParticipant.prototype.parseResult=function(a,b){if("[object Array]"===Object.prototype.toString.call(a)){var c=this;return a.map(function(a){return new FireModelInstanceTestParticipant(a,c,b)})}return new FireModelInstanceTestParticipant(a,this,b)},app.factory("TestParticipantModel",["$http","$q","FireModels",function(a,b,c){return new FireModelTestParticipant(a,b,c)}]),FireModelInstanceTestSession.prototype=Object.create(FireModelInstance.prototype),FireModelInstanceTestSession.prototype.getTest=function(a,b){var c=this;return this._model.models.Test._find(this._model.endpoint+"/"+this.id+"/test",a,b).then(function(a){return a&&a.length?(c.test=a[0],a[0]):null})},FireModelInstanceTestSession.prototype.createTest=function(a){var b=this;return this._model.models.Test._create(this._model.endpoint+"/"+this.id+"/test",a).then(function(a){return b.test=a,a})},FireModelInstanceTestSession.prototype.removeTest=function(){var a=this;return this._model.models.Test._action("delete",this._model.endpoint+"/"+this.id+"/test").then(function(b){return a.test=null,b})},FireModelInstanceTestSession.prototype.getParticipant=function(a,b){var c=this;return this._model.models.TestParticipant._find(this._model.endpoint+"/"+this.id+"/participant",a,b).then(function(a){return a&&a.length?(c.participant=a[0],a[0]):null})},FireModelInstanceTestSession.prototype.createParticipant=function(a){var b=this;return this._model.models.TestParticipant._create(this._model.endpoint+"/"+this.id+"/participant",a).then(function(a){return b.participant=a,a})},FireModelInstanceTestSession.prototype.removeParticipant=function(){var a=this;return this._model.models.TestParticipant._action("delete",this._model.endpoint+"/"+this.id+"/participant").then(function(b){return a.participant=null,b})},FireModelTestSession.prototype=Object.create(FireModel.prototype),FireModelTestSession.prototype.parseResult=function(a,b){if("[object Array]"===Object.prototype.toString.call(a)){var c=this;return a.map(function(a){return new FireModelInstanceTestSession(a,c,b)})}return new FireModelInstanceTestSession(a,this,b)},app.factory("TestSessionModel",["$http","$q","FireModels",function(a,b,c){return new FireModelTestSession(a,b,c)}]),FireModelInstanceTestVariant.prototype=Object.create(FireModelInstance.prototype),FireModelInstanceTestVariant.prototype.getTest=function(a,b){var c=this;return this._model.models.Test._find(this._model.endpoint+"/"+this.id+"/test",a,b).then(function(a){return a&&a.length?(c.test=a[0],a[0]):null})},FireModelInstanceTestVariant.prototype.createTest=function(a){var b=this;return this._model.models.Test._create(this._model.endpoint+"/"+this.id+"/test",a).then(function(a){return b.test=a,a})},FireModelInstanceTestVariant.prototype.removeTest=function(){var a=this;return this._model.models.Test._action("delete",this._model.endpoint+"/"+this.id+"/test").then(function(b){return a.test=null,b})},FireModelTestVariant.prototype=Object.create(FireModel.prototype),FireModelTestVariant.prototype.parseResult=function(a,b){if("[object Array]"===Object.prototype.toString.call(a)){var c=this;return a.map(function(a){return new FireModelInstanceTestVariant(a,c,b)})}return new FireModelInstanceTestVariant(a,this,b)},app.factory("TestVariantModel",["$http","$q","FireModels",function(a,b,c){return new FireModelTestVariant(a,b,c)}]),app.service("FireModels",["$http","$q",function(a,b){this.Test=new FireModelTest(a,b,this),this.TestParticipant=new FireModelTestParticipant(a,b,this),this.TestSession=new FireModelTestSession(a,b,this),this.TestVariant=new FireModelTestVariant(a,b,this)}]),app.service("fire",["FireModels","$http","$q",function(a){function b(a,b){var c=b;return a.then(function(a){angular.copy(a,c)}),c}this.unwrap=b,this.models=a}]),app.provider("_Template",["$injector",function(a){this.getTemplateUrl=function(b){return console.log("this#getTemplateUrl"),a.get(b)},this.$get=function(){return{}}}]),app.config(["$routeProvider","$locationProvider","_TemplateProvider",function(a,b){b.html5Mode({enabled:!0,requireBase:!1}),a.when("/",{controller:"StartController",resolve:{TextOfButtonTest:["TextOfButtonTest",function(a){return a.participate()}]}})}]),app.service("ChannelService",["WebSocketService","$rootScope",function(a,b){function c(a,b){return b+":"+a}var d={};this.registerChannel=function(a){d[c(a.id,a.type)]=a,this.sendMessageOnChannel({event:"_subscribe"},a)},this.getChannel=function(a,b){return d[c(a,b)]},this.getUnknownMessage=function(){console.log("Unknown message.")},this.sendMessageOnChannel=function(b,c){return a.send({channel:{type:c.type,id:c.id},message:b})};var e=this;a.parsePacket=function(a){var c=e.getChannel(a.channel.id,a.channel.type);c?c.delegate?b.$apply(function(){c.delegate(a.message)}):console.log("Warning: no delegate set on channel."):b.$apply(function(){e.getUnknownMessage(a.message,a.channel)})}}]),app.service("WebSocketService",["$location","$timeout",function(a,b){function c(){g++,i=new WebSocket("ws://"+a.host()+(a.port()?":"+a.port():"")),i.onopen=k,i.onerror=l,i.onclose=m,i.onmessage=n}var d=[],e=1e3,f=1.5,g=0,h=6e4,i=null,j=this,k=function(){if(d&&d.length>0){var a=d;d=null,a.forEach(function(a){j.send(a)})}},l=function(a){console.log("error"),console.log(a)},m=function(){b(c,Math.max(h,e*Math.pow(f,g)))},n=function(a){var b=JSON.parse(a.data);j.parsePacket&&j.parsePacket(b)};this.send=function(a){null!==d?d.push(a):(console.log(i),i.send(JSON.stringify(a)))},this.parsePacket=null,c()}]),app.service("_StorageService",[function(){var a={};this.get=function(b){return"undefined"!=typeof a[b]?a[b]:window.localStorage.getItem(b)},this.set=function(b,c){try{window.localStorage.setItem(b,c)}catch(d){a[b]=c}},this.unset=function(b){"undefined"!=typeof a[b]?delete a[b]:window.localStorage.removeItem(b)}}]),app.provider("TestsService",[function(){var a=null;this.delegate=function(b){a=b},this.$get=function(){return{participate:function(b,c){if(null===a)throw new Error("Please set the TestsService.delegate");if("function"!=typeof a)throw new Error("TestsService#delegate must be a function.");a(b,c)}}}}]),app.service("TextOfButtonTest",["$q","$http","_StorageService","TestsService",function(a,b,c,d){var e=this;this.participate=function(){var f=c.get("TextOfButtonTest");if(f)return d.participate("TextOfButtonTest",f),e;var g=a.defer();return b.post("/tests/text-of-button-test").success(function(a){c.set("TextOfButtonTest",a.variant),d.participate("TextOfButtonTest",a.variant),g.resolve(e)}).error(function(){g.reject(new Error)}),g.promise},this.getVariant=function(){var a=c.get("TextOfButtonTest");if(a)return a;throw new Error("Not participated")}}]);
//# sourceMappingURL=fire.min.js.map